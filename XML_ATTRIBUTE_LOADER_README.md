# XMLファイルの属性テーブル読み込み機能

このプラグインに、XMLファイルを単純な属性テーブル（ジオメトリなし）として読み込む機能を統合しました。**複数のXMLファイルを自動的にタイプ別にマージする機能**も含まれています。

## 機能概要

- XMLファイルを解析して、QGIS上で属性テーブルとして表示
- ジオメトリを持たないメモリレイヤとして作成
- XMLの構造を自動分析してフィールドを生成
- エラーハンドリングとユーザーフレンドリーなメッセージ表示
- **データロード機能に統合**: CSV等と同じように選択・読み込み可能
- **🆕 XMLタイプ別マージ機能**: 同じタイプのXMLファイルを自動的に統合
- **🆕 国土交通省XML対応**: MLIT XML形式の自動検出と最適化処理

## 使用方法

### 🔄 統合されたデータロード (推奨)

1. QGISでプラグインを起動
2. データセット・リソースを選択（XMLファイルを含む）
3. 「データロード」ボタンをクリック
4. XMLファイルが自動的に属性テーブルとして読み込まれる

**✨ 自動実行されるメリット:**
- CSV、JSON、Shapefile等と同時に一括処理
- 複数のXMLファイルを同時に読み込み
- **同じタイプのXMLファイルは自動的にマージされる（設定不要）**
- 統一されたエラーハンドリング
- 既存のワークフローに自然に統合
- **手動操作なし**: ファイル選択だけで自動的にマージ処理が実行

### 🔀 XMLファイルのマージ機能

複数のXMLファイルが同じディレクトリにある場合、以下のように処理されます：

1. **XMLタイプの自動検出**: DTD、名前空間、ルート要素等を分析
2. **同一タイプのグループ化**: 同じMLIT XML形式や構造を持つファイルをグループ化
3. **自動マージ**: 同じタイプのファイルは1つのレイヤにマージ
4. **ソースファイル情報**: 各レコードにどのファイルから来たかの情報を追加

### 🏷️ レイヤ名の付け方

- **単一ファイル**: `XML_Attributes_{ファイル名}` (元のファイル名ベース)
- **統合ファイル**: `{絵文字付きXMLタイプ名} (統合 {ファイル数}ファイル)`

**🎯 レイヤ名の例:**
- 単一ファイル: `XML_Attributes_construction_A` (元のファイル名ベース)
- 複数ファイル統合: `🏗️ 建設工事関連XML (統合 3ファイル)` (XMLタイプ名)
- 単一河川データ: `XML_Attributes_river_data_2023`
- 統合測量データ: `📐 測量成果XML (測量成果電子納品要領) (統合 2ファイル)`

### 🎨 対応XMLタイプとレイヤ名

各XMLタイプには分かりやすい絵文字付きレイヤ名が自動的に割り当てられます：

- 📋 電子納品XML (CALS/EC準拠)
- 📐 測量成果XML (測量成果電子納品要領)
- 🗺️ JPGIS準拠地理空間情報XML
- 📐 CAD/SXF関連XML
- 💰 積算システムXML (JACIC準拠)
- 🏢 施設管理XML
- 🌏 地理空間情報XML
- 🏗️ 建設工事関連XML
- 📄 国土交通省報告書データ
- 📝 日本語XML（報告書/情報系）
- 🗺️ GML/地理情報XML
- 📊 データテーブルXML
- 📄 汎用XML

## サポートするXML形式

### 基本形式
```xml
<?xml version="1.0" encoding="UTF-8"?>
<data>
    <record>
        <id>1</id>
        <name>データ名</name>
        <category>カテゴリ</category>
        <description>説明</description>
    </record>
    <record>
        <id>2</id>
        <name>データ名2</name>
        <category>カテゴリ2</category>
        <description>説明2</description>
    </record>
</data>
```

### 国土交通省 (MLIT) XML形式
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE ksj_app_schema SYSTEM "KS-META-13-v1_0.dtd">
<ksj_app_schema>
    <gml:featureMember>
        <ksj:W09 gml:id="W09_001">
            <ksj:POS>139.123456 35.654321</ksj:POS>
            <ksj:W09_001>01</ksj:W09_001>
            <ksj:W09_002>東京</ksj:W09_002>
            <ksj:W09_003>河川水位観測所</ksj:W09_003>
        </ksj:W09>
    </gml:featureMember>
</ksj_app_schema>
```

### ネストした構造
```xml
<?xml version="1.0" encoding="UTF-8"?>
<companies>
    <company>
        <basic_info>
            <company_id>COMP001</company_id>
            <name>会社名</name>
        </basic_info>
        <contact>
            <address>住所</address>
            <phone>電話番号</phone>
        </contact>
    </company>
</companies>
```

### 日本語要素名とDTD宣言付きXML
```xml
<?xml version="1.0" encoding="Shift_JIS" ?>
<!DOCTYPE reportdata SYSTEM "REP04.DTD">
<?xml-stylesheet type="text/xsl" href="REP04.XSL"?>
<reportdata DTD_version="04">
  <報告書ファイル情報>
    <報告書名>業務概要版</報告書名>
    <報告書ファイル名>REPORT01.PDF</報告書ファイル名>
    <報告書ファイル日本語名>業務概要版.PDF</報告書ファイル日本語名>
    <報告書オリジナルファイル情報>
      <報告書オリジナルファイル名>REP01_01.DOC</報告書オリジナルファイル名>
      <報告書オリジナルファイル日本語名>概要版004.DOC</報告書オリジナルファイル日本語名>
    </報告書オリジナルファイル情報>
  </報告書ファイル情報>
</reportdata>
```

## 特殊機能

### 多言語サポート
- **日本語要素名**: XML要素名が日本語で書かれているファイルに対応
- **複数エンコーディング**: UTF-8、Shift_JIS、EUC-JP、ISO-2022-JPなどに対応

### DTD・スタイルシート対応
- **DTD宣言**: `<!DOCTYPE>` 宣言があるXMLファイルも処理可能
- **スタイルシート**: `<?xml-stylesheet>` 宣言があるファイルも対応

### ネストした要素の処理
- **階層構造**: 複数レベルのネスト要素を自動的にフラット化
- **ドット記法**: ネストした要素は「親.子」の形式でフィールド名を生成
- **複数値対応**: 同じ要素名で複数の値がある場合は「|」区切りで結合

### エラーハンドリング
- **詳細診断**: ファイルの存在、権限、エンコーディング、XML構文を包括的にチェック
- **分かりやすいエラーメッセージ**: 問題の原因と対処法を具体的に表示
- **ログ機能**: QGISメッセージパネルに詳細なログを出力
- **マルチバイトエンコーディング対応**: ElementTreeの制限を回避し、Shift_JISなどのファイルも処理可能

### 技術的な改善（v1.1）
- **エンコーディング問題の解決**: "multi-byte encodings are not supported" エラーを解決
- **事前エンコーディング変換**: XMLファイルを読み込み時に適切なエンコーディングで処理
- **XML宣言の自動修正**: エンコーディング宣言をElementTree互換形式に自動変換

## 自動フィールド生成

XMLローダーは以下のフィールドを自動生成します：

- `xml_id`: レコード番号（整数）
- `element_path`: XML要素のパス（文字列）
- XML要素名に基づくカスタムフィールド（文字列）
- ネストした要素は「親.子」形式でフィールド名を生成

## エラーハンドリング

- XMLファイルが存在しない場合
- XML形式が不正な場合
- フィールドが検出できない場合
- 一般的な読み込みエラー

すべてQGISのメッセージバーとログに記録されます。

## 技術仕様

### ファイル構成
- `xml_attribute_loader.py`: XMLの解析とQGISレイヤ作成を担当するメインクラス
  - XMLタイプ識別機能
  - 複数ファイルのマージ機能
  - MLIT XML形式の特別処理
- `mlit_xml_checker.py`: MLIT XML形式の診断ツール
- `util.py`: データロード機能でXMLファイルの処理を統合（`_process_xml_files()`メソッド）
- `ckan_browser_dialog.py`: メインダイアログ（XMLは通常のデータロードで処理）

### 統合されたワークフロー
XMLファイルは `util.py` の `add_lyrs_from_dir()` メソッドで自動的に検出され、複数ファイルのマージ機能で処理されます：

1. **.xml** ファイルが検出される
2. `_process_xml_files()` メソッドが呼び出される
3. 複数ファイルの場合は `XMLAttributeLoader.load_multiple_xml_merged()` を実行
4. 同じタイプのファイルが自動的にグループ化・マージされる
5. 統合されたメモリレイヤがQGISに追加される

### XMLマージ機能の詳細

#### タイプ識別方法
1. **DTD識別**: DOCTYPE宣言のシステムIDを分析
2. **名前空間検出**: XML名前空間URIの解析
3. **ルート要素**: ルート要素名とその構造
4. **キーワードマッチング**: 特定のMLIT XMLパターン
5. **信頼度スコア**: 複数の指標による総合判定

#### マージプロセス
1. **ファイルグループ化**: 同一タイプのファイルを特定
2. **スキーマ統合**: 全ファイルのフィールド構造を統合
3. **データマージ**: 属性データを統合レイヤに結合
4. **ソースファイル情報追加**: `source_file`フィールドで元ファイルを追跡

## テスト方法

### 基本テスト
```bash
# テストファイルを作成
python test_xml_merge.py

# QGISでtest_xml_mergeフォルダを選択してデータロード
```

### 手動テスト
1. 複数のMLIT XMLファイルを同じフォルダに配置
2. QGISでCKAN Browser Pluginを開く
3. そのフォルダを選択してデータロード
4. 同じタイプのファイルがマージされることを確認

### 診断ツール
```bash
# MLIT XML形式の診断
python -c "from qgis_data_catalog_integration.mlit_xml_checker import diagnose_mlit_xml; diagnose_mlit_xml('your_file.xml')"
```

## トラブルシューティング

### マージされない場合
- XMLファイルのタイプが正しく識別されているか確認
- DTDやスキーマ情報が類似しているか確認
- ログメッセージでタイプ識別結果を確認

### エンコーディングエラー
- 日本語XMLファイルのエンコーディング（Shift_JIS、UTF-8など）
- ファイル先頭のBOM有無を確認
- 自動エンコーディング検出が正常に動作しているか確認

### パフォーマンス問題
- 大量のXMLファイルの場合は分割処理を検討
- メモリ使用量の監視
- ファイルサイズと処理時間の確認

これにより、XML読み込みは他のデータ形式（CSV、Shapefile等）と同じフローで処理されます。

### 主要メソッド
- `XMLAttributeLoader.load_xml_file(file_path)`: XMLファイルからQGISレイヤを作成
- `_parse_xml_with_encoding(file_path)`: エンコーディングを考慮したXML解析
- `_analyze_xml_structure(root)`: XML構造の分析とフィールド定義
- `_create_memory_layer(name, fields)`: メモリレイヤの作成
- `util._open_xml_attributes(file_path)`: データロード統合のエントリーポイント

## 使用例

1. **CKANリソースの一括読み込み**:
   - CSV、JSON、XMLファイルを含むリソースを一度に選択
   - 「データロード」ボタンで全てのファイルが適切な形式で読み込まれる
   
2. **ローカルフォルダーからの読み込み**:
   - 混在するファイル形式（.csv, .shp, .xml）のフォルダーを指定
   - XMLファイルは自動的に属性テーブルとして処理される
   
3. **データ分析ワークフロー**:
   - 統計データ（XML）、地理データ（Shapefile）、補助データ（CSV）を統合して分析

- **開発言語**: Python 3
- **依存関係**: 標準ライブラリのxml.etree.ElementTreeを使用
- **QGISバージョン**: 3.x対応
- **ライセンス**: GNU GPL v2

## 注意事項

- この機能は属性データのみを扱います（空間データは含まれません）
- 大きなXMLファイルの場合、読み込みに時間がかかる場合があります
- XML内の全要素が文字列として扱われます（数値型変換は現在未対応）